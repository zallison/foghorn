# Example configuration for the DNS caching server
listen:
  host: 127.0.0.1
  port: 5300

# Multiple upstream DNS servers with automatic failover
upstream:
  - host: 8.8.8.8
    port: 53
  - host: 1.1.1.1
    port: 53

# Global timeout applies to each upstream attempt
timeout_ms: 2000

# Minimum cache TTL (in seconds) applied to ***all*** cached responses.
# - For NOERROR with answers: cache TTL = max(min(answer TTLs), min_cache_ttl)
# - For NOERROR with no answers, NXDOMAIN, and SERVFAIL: cache TTL = min_cache_ttl
# Note: TTL field in the DNS response is not rewritten; this controls cache expiry only.
min_cache_ttl: 60

# Logging configuration
logging:
  level: debug            # Available levels: debug, info, warn, error, crit
  stderr: true            # Log to stderr (default: true)
  file: /tmp/foghorn.log  # Optional: also log to this file
  syslog: false           # Optional: also log to syslog

# Statistics collection and reporting
statistics:
  enabled: true                 # Enable periodic statistics logging (default: false)
  interval_seconds: 10          # Log stats every N seconds (default: 10)
  reset_on_log: false           # Reset counters after each log (default: false)
  log_level: info               # Log level for stats: debug, info, warning, error (default: info)
  include_qtype_breakdown: true # Track query type distribution (A, AAAA, etc.) (default: true)
  include_top_clients: true     # Track top N clients by request count (default: false)
  include_top_domains: true     # Track top N domains by request count (default: false)
  top_n: 10                     # Size of top-N lists when enabled (default: 10)
  track_latency: true           # Enable request latency histogram (default: false)
  track_uniques: true           # Track unique client IPs and domains (default: true)
  # Statistics output format: single-line JSON to foghorn.stats logger
  # Example log line:
  # {"ts":"2025-11-08T06:00:00Z","totals":{"total_queries":1240,"cache_hits":900,"cache_misses":340},
  #  "uniques":{"clients":54,"domains":312},"rcodes":{"NOERROR":980,"NXDOMAIN":190,"SERVFAIL":70},
  #  "qtypes":{"A":850,"AAAA":270},"upstreams":{"8.8.8.8:53":{"success":1120,"timeout":20}},
  #  "latency":{"count":1240,"min_ms":1.2,"max_ms":45.3,"avg_ms":3.1,"p50_ms":2.8,"p90_ms":8.4,"p99_ms":22.1}}

plugins:
  - module: new_domain
    config:
      threshold_days: 14

  - module: greylist
    config:
      duration_seconds: 60
  #     # duration_hours: 1 # Only if duration_seconds isn't provided
  #     # db_path: ./greylist.db

  # - module: router
  #   config:
  #     routes:
  #       # Single upstream (legacy format)
  #       - suffix: ".mylan"
  #         upstream:
  #           host: 192.168.1.1
  #           port: 53
  #       # Multiple upstreams with failover (new format)
  #       - suffix: "corp.internal"
  #         upstreams:
  #           - host: 10.0.0.1
  #             port: 53
  #           - host: 10.0.0.2
  #             port: 53

  # - module: filter
  #   config:
  #     # Pre-resolve (domain) filtering
  #     blocked_domains:
  #       - "malware.com"
  #       - "phishing-site.org"
  #       - "spam.example"

  #     blocked_patterns:
  #       - ".*\\.porn\\..*"      # Block any domain with "porn" in subdomain
  #       - "casino[0-9]+\\..*"   # Block casino1.com, casino2.net, etc.
  #       - ".*adult.*"           # Block domains containing "adult"

  #     blocked_keywords:
  #       - "porn"
  #       - "gambling"
  #       - "casino"
  #       - "malware"
  #       - "phishing"

  #     # Post-resolve (IP) filtering with per-IP actions
  #     blocked_ips:
  #       # Remove just the matching IP(s)
  #       - ip: "23.220.75.245/16"
  #         action: "remove"
  #       # Deny entire response if any returned IPs are found
  #       - ip: "1.2.3.4"
  #         action: "deny"

  # - module: foghorn.plugins.examples.ExamplesPlugin
  #   config:
  #     # Pre-resolve policy
  #     max_subdomains: 5
  #     max_length_no_dots: 50
  #     base_labels: 2

  #     # Post-resolve IP rewrite rules
  #     rewrite_first_ipv4:
  #       - apply_to_qtypes: ["A"]
  #         ip_override: 127.0.0.1
  #       - apply_to_qtypes: ["AAAA"]
  #         ip_override: ::1
