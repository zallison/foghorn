# config.yaml – defaults for Foghorn with a minimal plugin set
# Below are the defaults

listen:
  udp:
    enabled: true
    host: 127.0.0.1
    port: 5333
  tcp:
    enabled: false
    host: 127.0.0.1
    port: 5333
  dot:
    enabled: false
    host: 127.0.0.1
    port: 8853
    # cert_file: /path/to/cert.pem
    # key_file: /path/to/key.pem
  doh:
    enabled: false
    host: 127.0.0.1
    port: 8053
    # cert_file: /path/to/cert.pem
    # key_file: /path/to/key.pem

upstream:
  # UDP upstream
  - host: 8.8.8.8
    port: 53
    transport: udp

  # TCP upstream
  - host: 8.8.4.4
    port: 53
    transport: tcp
    pool:
      max_connections: 32
      idle_timeout_ms: 15000

  # DoT upstream (DNS-over-TLS)
  - host: 1.1.1.1
    port: 853
    transport: dot
    tls:
      server_name: cloudflare-dns.com
      verify: true
      # ca_file: /etc/ssl/certs/ca-certificates.crt
    pool:
      max_connections: 64
      idle_timeout_ms: 30000

  # DoH upstream (DNS-over-HTTPS)
  - transport: doh
    url: https://dns.google/dns-query
    method: POST
    headers:
      user-agent: foghorn
    tls:
      verify: true
      # ca_file: /etc/ssl/certs/ca-certificates.crt

timeout_ms: 2000
min_cache_ttl: 60

dnssec:
  mode: ignore
  validation: upstream_ad
  udp_payload_size: 1232

logging:
  level: info
  stderr: true
  # file: /var/log/foghorn/foghorn.log
  # syslog: true

statistics:
  enabled: false
  interval_seconds: 300        # 5 minutes
  reset_on_log: false
  include_qtype_breakdown: true
  include_top_clients: true
  include_top_domains: true
  top_n: 10
  track_latency: true

  persistence:
    enabled: true
    db_path: ./config/var/stats.db
    batch_writes: true
    batch_time_sec: 15.0
    batch_max_size: 1000

  ignore:
    top_clients: []
    top_domains: []
    top_subdomains: []
    top_domains_mode: exact
    top_subdomains_mode: exact
    ignore_single_host: false

webserver:
  enabled: false
  host: 127.0.0.1
  port: 8053
  logs:
    buffer_size: 500
  system_info_ttl_seconds: 2.0
  system_metrics_detail: full
  debug_timings: false
  index: true

  auth:
    mode: none
    # token: "change-me"

  cors:
    enabled: false
    allowlist: []

  redact_keys:
    - token
    - password
    - secret

plugins:
  # 1) /etc/hosts resolver – answers from hosts files first when possible
  - module: hosts
    pre_priority: 10           # run early
    config:
      allow: ["192.0.2.0/24", "2001:db8::/32"]
      servfail_one_in: 20
      nxdomain_one_in: 50
      apply_to_qtypes: ["A", "AAAA"]
      # seed: 42

  # 3) Download curated domain lists before filtering (ensures files exist).
  # Runs early in setup so files are present before Filter setup.
  - module: list_downloader
    config:
      setup_priority: 15
      download_path: ./config/var/lists
      interval_days: 1
      urls:
        - https://v.firebog.net/hosts/AdguardDNS.txt
        - https://v.firebog.net/hosts/Easylist.txt
        - https://v.firebog.net/hosts/Prigent-Ads.txt
        - https://v.firebog.net/hosts/Prigent-Malware.txt

  # 4) Filter domains/IPs before routing (policy enforcement)
  - module: filter
    pre_priority: 20
    post_priority: 20
    config:
      setup_priority: 20
      default: deny
      db_path: ./config/var/blocklist.db
      cache_ttl_seconds: 600
      blocked_domains: ["tracker.example"]
      allowed_domains: ["intranet.example"]
      blocked_patterns: [".*\\.ads\\..*"]
      blocked_keywords: ["gambling"]
      blocked_ips:
        - { ip: "198.51.100.0/24", action: remove }
        - { ip: "203.0.113.5", action: replace, replace_with: "127.0.0.1" }
      # Enable external lists (downloaded above to ./config/var/lists/)
      blocklist_files:
        - ./config/var/lists/AdguardDNS-*.txt
        - ./config/var/lists/Easylist-*.txt
        - ./config/var/lists/Prigent-Ads-*.txt
        - ./config/var/lists/Prigent-Malware-*.txt
      allowlist_files:
        - ./config/allow.txt
      blocklist_files:
        - ./config/block.txt
      allowed_domains_files: []
      blocked_domains_files: []

  # 4) Route certain domains to internal upstreams
  - module: upstream
    pre_priority: 30
    config:
      routes:
        - domain: "internal.example"
          upstreams:
            - { host: "10.0.0.2", port: 53 }
            - { host: "10.0.0.3", port: 53 }
        - suffix: "corp"
          upstreams:
            - { host: "10.0.1.1", port: 53 }

  # 5) Greylist to slow down first-seen domains
  - module: greylist
    pre_priority: 40
    config:
      duration_seconds: 3600
      db_path: ./config/var/greylist.db

  # 6) Block newly registered domains below threshold
  - module: new_domain
    pre_priority: 50
    config:
      threshold_days: 14
      whois_db_path: ./config/var/whois_cache.db
      # whois_cache_ttl_seconds: 3600
      # whois_refresh_seconds: 86400

  # 7) Local overrides from hosts file (A-only)
  - module: etc-hosts
    pre_priority: 55
    config:
      # file_path: /etc/hosts

  # 3) Upstream router – send certain suffixes to specific upstreams
  - module: router
    pre_priority: 30
    config:
      routes: []
      # Example: internal corp domains to some internal resolver
      # - suffix: corp.internal
      #   upstreams:
      #     - host: 10.0.0.1
      #       port: 53
      #     - host: 10.0.0.2
      #       port: 53
      #
      # Example: lab domains to a lab resolver
      # - suffix: lab.local
      #   upstreams:
      #     - host: 192.168.1.1
      #       port: 53
