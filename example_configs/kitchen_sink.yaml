# Foghorn kitchen-sink example: combine multiple plugins
# Demonstrates ordering and interactions via pre_priority/post_priority.

listen:
  udp:
    enabled: true
    host: 127.0.0.1
    port: 5353
  tcp:
    enabled: false
  dot:
    enabled: false

# A safe default upstream set; specific routes may override
upstream:
  - { host: 1.1.1.1, port: 53 }
  - { host: 8.8.8.8, port: 53 }

dnssec:
  mode: passthrough
  validation: upstream_ad
  udp_payload_size: 1232

timeout_ms: 2000
logging:
  level: info

plugins:
  # 1) Run ACL very early to drop unwanted clients ASAP
  - module: acl
    pre_priority: 10
    config:
      default: allow
      allow:
        - 192.0.2.0/24
        - 10.0.0.0/8
        # - 2001:db8::/32
      deny:
        - 203.0.113.0/24

  # 2) Introduce flakiness early (test client resilience)
  - module: flaky
    pre_priority: 15
    config:
      allow: ["192.0.2.0/24", "2001:db8::/32"]
      servfail_one_in: 20
      nxdomain_one_in: 50
      apply_to_qtypes: ["A", "AAAA"]
      # seed: 42

  # 3) Download curated domain lists before filtering (ensures files exist)
  - module: list_downloader
    pre_priority: 15
    config:
      download_path: ./var/lists
      interval_seconds: 3600
      urls:
        - https://v.firebog.net/hosts/AdguardDNS.txt
        - https://v.firebog.net/hosts/Easylist.txt
        - https://v.firebog.net/hosts/Prigent-Ads.txt
        - https://v.firebog.net/hosts/Prigent-Malware.txt

  # 4) Filter domains/IPs before routing (policy enforcement)
  - module: filter
    pre_priority: 20
    config:
      default: deny
      db_path: ./var/blocklist.db
      cache_ttl_seconds: 600
      blocked_domains: ["tracker.example"]
      allowed_domains: ["intranet.example"]
      blocked_patterns: [".*\\.ads\\..*"]
      blocked_keywords: ["gambling"]
      blocked_ips:
        - { ip: "198.51.100.0/24", action: remove }
        - { ip: "203.0.113.5", action: replace, replace_with: "127.0.0.1" }
      # Enable external lists (downloaded above to ./var/lists/)
      blocklist_files:
        - ./var/lists/AdguardDNS-*.txt
        - ./var/lists/Easylist-*.txt
        - ./var/lists/Prigent-Ads-*.txt
        - ./var/lists/Prigent-Malware-*.txt
      allowlist_files:
        - example_configs/lists/allowlist.txt

  # 4) Route certain domains to internal upstreams
  - module: upstream
    pre_priority: 30
    config:
      routes:
        - domain: "internal.example"
          upstreams:
            - { host: "10.0.0.2", port: 53 }
            - { host: "10.0.0.3", port: 53 }
        - suffix: "corp"
          upstreams:
            - { host: "10.0.1.1", port: 53 }

  # 5) Greylist to slow down first-seen domains
  - module: greylist
    pre_priority: 40
    config:
      duration_seconds: 3600
      db_path: ./var/greylist.db

  # 6) Block newly registered domains below threshold
  - module: new_domain
    pre_priority: 50
    config:
      threshold_days: 14
      whois_db_path: ./var/whois_cache.db
      # whois_cache_ttl_seconds: 3600
      # whois_refresh_seconds: 86400

  # 7) Local overrides from hosts file (A-only)
  - module: etc-hosts
    pre_priority: 55
    config:
      # file_path: /etc/hosts

  # 8) Example post-processing rewrite at the end
  - module: examples
    post_priority: 90
    config:
      max_subdomains: 5
      max_length_no_dots: 50
      base_labels: 2
      apply_to_qtypes: ["*"]
      rewrite_first_ipv4:
        - { apply_to_qtypes: ["A"], ip_override: "127.0.0.1" }

# Ordering notes:
# - Lower pre_priority runs earlier; higher post_priority runs later.
# - Typical chain (pre): ACL -> Flaky -> Filter -> Router -> Greylist -> NewDomain -> EtcHosts
# - Post-processing (e.g., Examples rewrite) should be last to avoid interfering with policy checks.
